from PymoNNto import *
import tensorflow as tf
import time

steps=[100*1.2**(i+1) for i in range(26)]

class Basic_Behaviour_Tensorflow(Behaviour):

    def set_variables(self, neurons):
        neurons.voltage = tf.Variable(neurons.get_neuron_vec(), dtype='float32')
        neurons.spike = tf.Variable(neurons.get_neuron_vec(), dtype='float32')
        self.threshold = tf.constant(0.5, dtype='float32')
        self.decay_factor = tf.constant(0.9, dtype='float32')

    def new_iteration(self, neurons):
        firing = tf.greater(neurons.voltage, self.threshold)
        neurons.spike.assign(tf.cast(firing, dtype='float32'))#spikes

        not_firing = tf.cast(tf.math.logical_not(firing), dtype='float32')#reset
        neurons.voltage.assign(tf.multiply(neurons.voltage, not_firing))

        new_voltage = tf.multiply(neurons.voltage, self.decay_factor)#voltage decay
        rnd_act = tf.constant(neurons.get_neuron_vec('uniform', density=0.01), dtype='float32')
        neurons.voltage.assign(tf.add(new_voltage, rnd_act)) #noise


class Input_Behaviour_Tensorflow(Behaviour):

    def set_variables(self, neurons):
        for syn in neurons.afferent_synapses['GLUTAMATE']:
            syn.W = tf.Variable(syn.get_synapse_mat('uniform', density=0.1), dtype='float32')

    def new_iteration(self, neurons):
        for synapse in neurons.afferent_synapses['GLUTAMATE']:
            W_act_mul = tf.linalg.matvec(synapse.W, synapse.src.spike)
            delta_act = tf.divide(W_act_mul, synapse.src.size/10.0)
            neurons.voltage.assign(tf.add(neurons.voltage, delta_act))




class Basic_Behaviour(Behaviour):

    def set_variables(self, neurons):
        neurons.voltage = neurons.get_neuron_vec()
        self.threshold = 0.5
        self.leak_factor = self.get_init_attr('leak_factor', 0.9, neurons)

    def new_iteration(self, neurons):
        firing = neurons.voltage > self.threshold
        neurons.spike = firing.astype(def_dtype) #spikes
        neurons.voltage[firing] = 0.0 #reset

        neurons.voltage *= self.leak_factor #voltage decay
        neurons.voltage += neurons.get_neuron_vec('uniform',density=0.01) #noise


class Input_Behaviour(Behaviour):

    def set_variables(self, neurons):
        for synapse in neurons.afferent_synapses['GLUTAMATE']:
            synapse.W = synapse.get_synapse_mat('uniform', density=0.1)
            #synapse.enabled = synapse.W > 0

    def new_iteration(self, neurons):
        for synapse in neurons.afferent_synapses['GLUTAMATE']:
            neurons.voltage += synapse.W.dot(synapse.src.spike)/synapse.src.size*10




measurements_np = []
measurements_tf = []

for r in range(10):
    measurements_np.append([])

    for N_e in steps:#[100 * (i + 1) for i in range(100)]

        My_Network = Network()

        My_Neurons = NeuronGroup(net=My_Network, tag='my_neurons', size=int(N_e), behaviour={#get_squared_dim()
            1: Basic_Behaviour(),
            2: Input_Behaviour(),
            # 9: Recorder(tag='my_recorder', variables=['n.voltage', 'np.mean(n.voltage)']),
            # 10: EventRecorder(tag='my_event_recorder', variables=['n.spike'])
        })

        #My_Neurons.visualize_module()

        my_syn = SynapseGroup(net=My_Network, src=My_Neurons, dst=My_Neurons, tag='GLUTAMATE')

        My_Network.initialize()

        start = time.time()

        My_Network.simulate_iterations(1000, measure_block_time=True)

        measure = time.time() - start
        print('np', N_e, measure)
        measurements_np[-1].append(measure)

    measurements_tf.append([])

    for N_e in steps:#[100*(i+1) for i in range(100)]

        My_Network = Network()

        My_Neurons = NeuronGroup(net=My_Network, tag='my_neurons', size=int(N_e), behaviour={#get_squared_dim()
            1: Basic_Behaviour_Tensorflow(),
            2: Input_Behaviour_Tensorflow(),
            #9: Recorder(tag='my_recorder', variables=['n.voltage.numpy()', 'np.mean(n.voltage.numpy())'])
        })

        my_syn = SynapseGroup(net=My_Network, src=My_Neurons, dst=My_Neurons, tag='GLUTAMATE')

        My_Network.initialize()

        start = time.time()

        My_Network.simulate_iterations(1000, measure_block_time=True)

        measure=time.time()-start
        print('tf', N_e, measure)
        measurements_tf[-1].append(measure)

print(measurements_np)
print(measurements_tf)


import matplotlib.pyplot as plt

#measurements_np = [[0.17499780654907227, 0.18139076232910156, 0.16900014877319336, 0.17600250244140625, 0.21705961227416992, 0.28000617027282715, 0.2625091075897217, 0.28400373458862305, 0.2610037326812744, 0.339815616607666, 0.2715885639190674, 0.3222694396972656, 0.4718658924102783, 0.7036261558532715, 0.9568657875061035, 1.4280202388763428, 2.2019031047821045, 3.450554847717285, 4.691589117050171, 6.604087829589844, 9.590253591537476, 13.665497541427612, 19.65296483039856, 27.570769786834717, 37.92657518386841, 55.24544334411621], [0.2339646816253662, 0.2580544948577881, 0.2869727611541748, 0.3020009994506836, 0.30202150344848633, 0.3031470775604248, 0.2999997138977051, 0.3192899227142334, 0.3270134925842285, 0.32296323776245117, 0.37175488471984863, 0.4209589958190918, 0.5929872989654541, 0.7770154476165771, 1.0534489154815674, 1.4662196636199951, 2.2108969688415527, 3.2775230407714844, 4.61646842956543, 6.570427656173706, 9.56896185874939, 13.629098653793335, 19.598115921020508, 28.05506706237793, 41.46253848075867, 58.627907514572144], [0.28011178970336914, 0.2710139751434326, 0.32738280296325684, 0.32500529289245605, 0.35561347007751465, 0.3760054111480713, 0.3839597702026367, 0.41112327575683594, 0.3939673900604248, 0.40698933601379395, 0.4722168445587158, 0.5689561367034912, 0.6785798072814941, 0.8390851020812988, 1.18509840965271, 1.9994938373565674, 2.489523410797119, 3.198269844055176, 4.631079435348511, 6.5178062915802, 10.264365911483765, 14.897331714630127, 21.698575735092163, 30.927090883255005, 46.55745077133179, 64.14097476005554], [0.32300615310668945, 0.377002477645874, 0.3939967155456543, 0.3966712951660156, 0.3569982051849365, 0.3470022678375244, 0.31800055503845215, 0.36596012115478516, 0.4310035705566406, 0.3839595317840576, 0.3559610843658447, 0.42598819732666016, 0.5459609031677246, 0.7950031757354736, 1.0749967098236084, 1.4463222026824951, 2.0855112075805664, 2.898958444595337, 4.740752220153809, 7.013923168182373, 10.438331127166748, 14.96640682220459, 21.534990072250366, 31.314754962921143, 45.973877906799316, 66.77634286880493], [0.20195841789245605, 0.2220003604888916, 0.23400020599365234, 0.24601411819458008, 0.2759997844696045, 0.2839999198913574, 0.25799989700317383, 0.2879641056060791, 0.28375720977783203, 0.3215785026550293, 0.32296180725097656, 0.3509669303894043, 0.4259612560272217, 0.5569632053375244, 0.8216028213500977, 1.1459596157073975, 2.0706496238708496, 3.1861119270324707, 4.793044567108154, 6.939251661300659, 10.522681713104248, 15.201485872268677, 21.621668100357056, 30.845786571502686, 46.5147922039032, 66.87373328208923], [0.20195674896240234, 0.2219998836517334, 0.23799991607666016, 0.2460005283355713, 0.27168822288513184, 0.278001070022583, 0.2719998359680176, 0.2999997138977051, 0.2980020046234131, 0.3159968852996826, 0.34400200843811035, 0.32700657844543457, 0.40400218963623047, 0.5700008869171143, 0.8180015087127686, 1.215959072113037, 2.0780141353607178, 3.2001659870147705, 4.739196538925171, 6.473066806793213, 10.386634349822998, 15.193790435791016, 21.95504927635193, 31.261486053466797, 46.34678626060486, 65.8546769618988], [0.1999654769897461, 0.2240002155303955, 0.23669767379760742, 0.2440018653869629, 0.24911808967590332, 0.26600193977355957, 0.27199721336364746, 0.2879621982574463, 0.2940809726715088, 0.3119993209838867, 0.32953763008117676, 0.34311628341674805, 0.41196179389953613, 0.5628032684326172, 0.8119590282440186, 1.1406290531158447, 2.0799741744995117, 3.1980245113372803, 4.749982595443726, 6.770709753036499, 9.344077825546265, 15.069656372070312, 22.27019238471985, 31.409225463867188, 46.19327926635742, 66.3249454498291], [0.20323657989501953, 0.22453570365905762, 0.23799943923950195, 0.2460005283355713, 0.2519991397857666, 0.2650001049041748, 0.29654407501220703, 0.27500033378601074, 0.3100008964538574, 0.3290698528289795, 0.45356059074401855, 0.47880125045776367, 0.4119994640350342, 0.5750010013580322, 0.8160018920898438, 1.1655943393707275, 2.065002202987671, 3.2128095626831055, 4.78800368309021, 7.063551664352417, 10.569228172302246, 14.961506366729736, 22.12526774406433, 31.705601453781128, 46.44693636894226, 67.09688520431519], [0.1999654769897461, 0.22799992561340332, 0.23463129997253418, 0.24710631370544434, 0.2500004768371582, 0.2748069763183594, 0.2791459560394287, 0.2799656391143799, 0.27357006072998047, 0.3059685230255127, 0.323962926864624, 0.3459620475769043, 0.4116635322570801, 0.5699563026428223, 0.8318469524383545, 1.160219669342041, 2.0885977745056152, 3.2209115028381348, 4.767768621444702, 6.925143241882324, 10.514584302902222, 15.243524074554443, 21.672119140625, 31.352856636047363, 46.31177759170532, 67.07477188110352], [0.1999986171722412, 0.2219991683959961, 0.23400139808654785, 0.2460007667541504, 0.2700009346008301, 0.274000883102417, 0.2780029773712158, 0.285963773727417, 0.28767991065979004, 0.2879619598388672, 0.3438150882720947, 0.3195517063140869, 0.4319596290588379, 0.5679948329925537, 0.8079688549041748, 1.1783289909362793, 2.0783274173736572, 3.2256031036376953, 4.821169853210449, 6.894367694854736, 10.46570086479187, 15.036527156829834, 22.35624623298645, 29.493662118911743, 46.6861207485199, 65.82310223579407]]
#measurements_tf = [[1.13694429397583, 1.1097564697265625, 1.1354286670684814, 1.154494285583496, 1.2771034240722656, 1.1571323871612549, 1.1693737506866455, 1.1806731224060059, 1.2091999053955078, 1.1850085258483887, 1.1814777851104736, 1.2101523876190186, 1.2158491611480713, 1.2526733875274658, 1.3285624980926514, 1.3776237964630127, 1.4448482990264893, 1.5517442226409912, 1.713244915008545, 2.266692876815796, 2.1637957096099854, 2.6896860599517822, 3.520876169204712, 4.394878149032593, 5.690841436386108, 7.51257848739624], [0.930001974105835, 0.9609377384185791, 1.0440175533294678, 1.1399288177490234, 1.1780788898468018, 1.1660351753234863, 1.169999122619629, 1.1970882415771484, 1.2976949214935303, 1.205522060394287, 1.2081663608551025, 1.2192728519439697, 1.2406911849975586, 1.2798287868499756, 1.2981326580047607, 1.3905606269836426, 1.4308679103851318, 1.617213249206543, 1.7668688297271729, 2.0612642765045166, 2.2934515476226807, 2.799614429473877, 3.409940481185913, 4.624590635299683, 5.824159145355225, 7.824335813522339], [0.9280035495758057, 0.9727745056152344, 0.8289663791656494, 0.8553946018218994, 0.8280000686645508, 0.8346383571624756, 0.8420159816741943, 0.850034236907959, 0.8599350452423096, 0.8619658946990967, 0.8717036247253418, 0.8941366672515869, 1.0504772663116455, 1.106961727142334, 1.131937026977539, 1.189962387084961, 1.357801914215088, 1.3854639530181885, 1.6480813026428223, 1.7750885486602783, 2.0729761123657227, 2.5322041511535645, 3.8688690662384033, 4.050751447677612, 5.36760139465332, 7.1968770027160645], [0.8615014553070068, 0.8250014781951904, 0.826033353805542, 0.8269639015197754, 0.8270001411437988, 0.8299996852874756, 0.836899995803833, 0.8390369415283203, 0.8412494659423828, 0.8679983615875244, 0.869999885559082, 0.8839974403381348, 0.9055972099304199, 0.9390661716461182, 1.022127628326416, 1.1999526023864746, 1.2705790996551514, 1.3998653888702393, 1.567176103591919, 1.7959063053131104, 2.0771312713623047, 2.5279793739318848, 3.1826248168945312, 4.053677558898926, 5.480203866958618, 7.169400453567505], [0.8440001010894775, 0.8400394916534424, 0.8579950332641602, 0.8440167903900146, 0.8445117473602295, 0.8479998111724854, 0.8500003814697266, 0.8519878387451172, 0.8560361862182617, 0.878037691116333, 0.8861761093139648, 0.927316427230835, 0.9791133403778076, 0.9572231769561768, 0.9800021648406982, 1.114856481552124, 1.2845814228057861, 1.3884148597717285, 1.5469932556152344, 1.7771062850952148, 2.0169572830200195, 2.5373878479003906, 3.1891520023345947, 4.081675052642822, 5.387206077575684, 7.178711414337158], [0.8700006008148193, 0.8519999980926514, 0.8480172157287598, 0.8603880405426025, 0.8539998531341553, 0.8599996566772461, 0.8619990348815918, 0.8639991283416748, 0.8677668571472168, 0.8851628303527832, 0.9000606536865234, 0.9111123085021973, 0.9260008335113525, 0.9717364311218262, 1.0378267765045166, 1.2160015106201172, 1.2920005321502686, 1.402176856994629, 1.5820014476776123, 1.8614606857299805, 2.0199978351593018, 2.565373182296753, 3.1897902488708496, 4.055981159210205, 5.371796131134033, 7.1917338371276855], [0.8304097652435303, 0.823998212814331, 0.8450338840484619, 0.8309998512268066, 0.8316893577575684, 0.8330113887786865, 0.8330338001251221, 0.8310010433197021, 0.840944766998291, 0.8651630878448486, 0.8856654167175293, 0.8947267532348633, 0.8972349166870117, 0.9849615097045898, 1.1369893550872803, 1.1968696117401123, 1.2724313735961914, 1.3879599571228027, 1.5547919273376465, 1.7860028743743896, 2.0225162506103516, 2.6143174171447754, 3.1704962253570557, 4.030594825744629, 5.375802040100098, 7.160141944885254], [0.8498096466064453, 0.8520007133483887, 0.8559999465942383, 0.8539996147155762, 0.8560004234313965, 0.8599998950958252, 0.8599998950958252, 0.8618066310882568, 0.8660001754760742, 0.8827419281005859, 0.8785316944122314, 0.8999998569488525, 0.9080007076263428, 0.9490008354187012, 0.9740009307861328, 1.047001600265503, 1.2690017223358154, 1.3840014934539795, 1.5550014972686768, 1.7770018577575684, 2.0260019302368164, 2.532172679901123, 3.182262897491455, 4.043023347854614, 5.379992961883545, 7.156352519989014], [0.8707411289215088, 0.842033863067627, 0.8440334796905518, 0.8480017185211182, 0.8459999561309814, 0.8460352420806885, 0.8499565124511719, 0.859248161315918, 0.8611197471618652, 0.8820950984954834, 0.8860199451446533, 0.9019997119903564, 0.9180340766906738, 0.9543619155883789, 0.9860126972198486, 1.0419657230377197, 1.2579574584960938, 1.3857336044311523, 1.5918402671813965, 1.790332317352295, 2.032656669616699, 2.5369949340820312, 3.193082332611084, 4.055972337722778, 5.451130390167236, 7.159048557281494], [0.83803391456604, 0.83103346824646, 0.8500347137451172, 0.857656717300415, 0.8340294361114502, 0.834874153137207, 0.8452563285827637, 0.8559997081756592, 0.8612887859344482, 0.8860340118408203, 0.8941762447357178, 0.8999967575073242, 0.915961503982544, 0.9612908363342285, 0.9955649375915527, 1.1562628746032715, 1.277998447418213, 1.3849332332611084, 1.570056438446045, 1.793994426727295, 2.0164811611175537, 2.5276122093200684, 3.1858203411102295, 4.054441928863525, 5.374752521514893, 7.165963411331177]]

measurements_np = np.array(measurements_np)
measurements_tf = np.array(measurements_tf)

m_np_mean = np.mean(measurements_np, axis=0)
m_tf_mean = np.mean(measurements_tf, axis=0)

m_np_std = np.std(measurements_np, axis=0)
m_tf_std = np.std(measurements_tf, axis=0)

plt.fill_between(steps, m_np_mean - m_np_std, m_np_mean + m_np_std, color='#1f77b4', alpha=0.2)
plt.fill_between(steps, m_tf_mean - m_tf_std, m_tf_mean + m_tf_std, color='#ff7f0e', alpha=0.2)

plt.plot(steps, m_np_mean, color='#1f77b4', label='numpy')
plt.plot(steps, m_tf_mean, color='#ff7f0e', label='tensorflow')

plt.legend()

plt.xlabel('number of neurons')
plt.ylabel('seconds')
plt.yscale("log")
plt.xscale("log")
plt.show()

#[0.1999645233154297, 0.218003511428833, 0.2409965991973877, 0.24100112915039062, 0.24899935722351074, 0.2630031108856201, 0.28099799156188965, 0.31284523010253906, 0.32000279426574707, 0.35899925231933594, 0.4546220302581787, 0.5068552494049072, 0.6530053615570068, 0.7824952602386475, 0.9070553779602051, 1.050222396850586, 1.2891442775726318, 1.66923189163208, 1.60029935836792, 1.7296044826507568, 1.9204566478729248, 2.1690399646759033, 2.4417033195495605, 2.7384917736053467, 2.996511459350586, 3.2402493953704834, 3.5744411945343018, 3.7405831813812256, 4.142074346542358, 4.389730215072632, 4.720706224441528, 5.068341493606567, 5.323216199874878, 5.427221298217773, 6.041033029556274, 6.1748316287994385, 6.64346718788147, 7.3407182693481445, 7.764008522033691, 8.06881833076477, 8.047604084014893, 9.072882175445557, 9.604224681854248, 10.077693939208984, 10.647050619125366, 10.811450481414795, 10.993111848831177, 12.000470161437988, 12.116547346115112, 12.536857843399048, 12.88845944404602, 13.422639846801758, 14.475027561187744, 14.691237211227417, 15.31989574432373, 15.789008378982544, 15.725893020629883, 16.90374231338501, 17.846120834350586, 17.899065256118774, 19.737046718597412, 20.413366317749023, 20.703333616256714, 21.389984607696533, 22.651919841766357, 23.285500049591064, 24.05386972427368, 23.718878746032715, 23.88205051422119, 25.99735450744629, 26.330946683883667, 27.611251831054688, 25.931657075881958, 28.251221418380737, 29.352930784225464, 30.91769289970398, 31.067970752716064, 31.953543424606323, 33.25282263755798, 34.06226468086243, 34.59615874290466, 34.87780523300171, 36.2314133644104, 37.31342148780823, 38.83990836143494, 39.85849905014038, 39.83023977279663, 41.045506954193115, 41.741124391555786, 42.58165979385376, 36.91175675392151, 45.72424578666687, 46.39647197723389, 48.61268162727356, 48.692301988601685, 48.81277871131897, 47.00536918640137, 51.17316174507141, 52.45090198516846, 52.031840801239014]

#[7.5436859130859375, 0.952052116394043, 0.9580111503601074, 0.9685888290405273, 0.9637916088104248, 0.9609682559967041, 0.9582045078277588, 0.9666166305541992, 0.9602880477905273, 0.9593665599822998, 0.96071457862854, 0.9613845348358154, 0.9573400020599365, 0.9606430530548096, 0.957266092300415, 1.0250699520111084, 1.111067771911621, 1.1128811836242676, 1.112034797668457, 1.1252353191375732, 1.1131031513214111, 1.1081557273864746, 1.1075670719146729, 1.1076288223266602, 1.115097999572754, 1.112248420715332, 1.1637375354766846, 1.6383483409881592, 1.3756556510925293, 1.1744801998138428, 1.375967025756836, 1.275254487991333, 1.2132048606872559, 1.3637316226959229, 1.167999029159546, 1.110478162765503, 1.1121060848236084, 1.1140496730804443, 1.1111562252044678, 1.1099636554718018, 1.1093626022338867, 1.1175684928894043, 1.1157429218292236, 1.1157095432281494, 1.108757734298706, 1.1133456230163574, 1.1231358051300049, 1.1213793754577637, 1.1171722412109375, 1.1200764179229736, 1.2808949947357178, 1.113271951675415, 1.1118769645690918, 1.1159610748291016, 1.1039340496063232, 1.1137936115264893, 1.1079671382904053, 1.1162211894989014, 1.1065483093261719, 1.1100184917449951, 1.109309196472168, 1.115638256072998, 1.1088998317718506, 1.1106536388397217, 1.1103167533874512, 1.1180434226989746, 1.1076114177703857, 1.1195812225341797, 1.1154916286468506, 1.1275899410247803, 1.1083252429962158, 1.1417183876037598, 1.2657194137573242, 1.114706039428711, 1.110335111618042, 1.1145620346069336, 1.1165761947631836, 1.115522861480713, 1.1208722591400146, 1.1202313899993896, 1.1110260486602783, 1.1216835975646973, 1.118427038192749, 1.11830735206604, 1.11627197265625, 1.16538405418396, 1.1439399719238281, 1.1223349571228027, 1.1150081157684326, 1.116992712020874, 1.1149985790252686, 1.1209912300109863, 1.1163032054901123, 1.1139283180236816, 1.1196205615997314, 1.1200335025787354, 1.1184258460998535, 1.1198973655700684, 1.1210017204284668, 1.1307590007781982]
#[1.0375339984893799, 0.846888542175293, 0.8502368927001953, 0.874018669128418, 0.8646717071533203, 0.8777210712432861, 0.8826766014099121, 0.8949623107910156, 0.9039154052734375, 0.8959107398986816, 0.9153125286102295, 1.0273284912109375, 1.0967259407043457, 1.125180959701538, 1.1337387561798096, 1.282701015472412, 1.490036964416504, 1.2799286842346191, 1.4653677940368652, 1.2617661952972412, 1.5102744102478027, 1.433044672012329, 1.4594035148620605, 1.5002355575561523, 1.7913098335266113, 1.4519846439361572, 1.5072216987609863, 1.6268677711486816, 1.7098968029022217, 1.7852282524108887, 1.569800615310669, 1.592090368270874, 1.6580989360809326, 1.6143760681152344, 1.7648184299468994, 1.7046303749084473, 1.7859089374542236, 1.8046839237213135, 1.928462266921997, 1.998405933380127, 2.577794075012207, 2.218118667602539, 2.2270667552948, 2.478893280029297, 2.0960397720336914, 2.0741958618164062, 2.119929790496826, 2.2006101608276367, 2.368408441543579, 2.5351409912109375, 2.348578691482544, 2.535757303237915, 2.472599744796753, 2.5393736362457275, 3.3418073654174805, 2.674172878265381, 2.703228235244751, 2.778975009918213, 3.4673781394958496, 3.00382661819458, 3.040437698364258, 3.065504550933838, 3.147279739379883, 3.2131474018096924, 3.3391878604888916, 3.35221791267395, 3.3938090801239014, 3.60068941116333, 3.6466681957244873, 3.620664596557617, 3.6706175804138184, 3.6609838008880615, 3.7540321350097656, 3.850482225418091, 3.9147279262542725, 3.9719412326812744, 4.121798753738403, 4.182462453842163, 4.401285886764526, 4.502908945083618, 4.515851974487305, 4.420205116271973, 4.755411148071289, 4.661699295043945, 4.690902471542358, 4.761011600494385, 4.905830144882202, 4.967146873474121, 5.132516860961914, 5.1854941844940186, 5.16105580329895, 5.211744785308838, 5.413797855377197, 5.468248128890991, 5.737350702285767, 6.1713035106658936, 5.800194025039673, 5.879356384277344, 6.048494100570679, 5.962701082229614]
